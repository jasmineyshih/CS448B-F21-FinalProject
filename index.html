<!DOCTYPE html>
<meta charset="utf-8">

<html>

<head>
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>
<script src="scripts/util.js"></script>
<script src="scripts/preprocess.js"></script>
<script src="scripts/interaction.js"></script>
<script src="scripts/graphs.js"></script>
<link rel="stylesheet" href="styles.css">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
</head>

<body>

<div id='complete_tool'>
    <div id="barchart_side_bar">
        <div class="sidebar" id="sidebarTool">
            <div class="vizOptionsContainer">
                <div>Use divergent coloring on</div>
                <div class="networkVizOptions">
                    <div class="singleOption">
                        <input type="checkbox" name="treeEdgeColoring" onclick="updateEdgeColors('tree')" checked>
                        <label for="treeEdgeColoring">tree edges</label>
                    </div>
                    <div class="singleOption">
                        <input type="checkbox" name="extraEdgeAcrossColoring" onclick="updateEdgeColors('extraWithin')" checked>
                        <label for="extraEdgeAcrossColoring">non-tree edges within the same level</label>
                    </div>
                    <div class="singleOption">
                        <input type="checkbox" name="extraEdgeAcrossColoring" onclick="updateEdgeColors('extraAcross')" checked>
                        <label for="extraEdgeAcrossColoring">non-tree edges across different levels</label>
                    </div>
                </div>
            </div>
            <div class="vizOptionsContainer">
                <div>Vary node size by</div>
                <div class="networkVizOptions">
                    <div class="singleOption">
                        <input type="radio" id="incomingEdges" name="nodeSizeAttribute" value="incomingEdges" onclick="updateNodeSizeAttribute(this)">
                        <label for="incomingEdges">number of incoming edges</label>
                    </div>
                    <div class="singleOption">
                        <input type="radio" id="outgoingEdges" name="nodeSizeAttribute" value="outgoingEdges" onclick="updateNodeSizeAttribute(this)">
                        <label for="outgoingEdges">number of outgoing edges</label>
                    </div>
                    <div class="singleOption">
                        <input type="radio" id="numLikes" name="nodeSizeAttribute" value="numLikes" onclick="updateNodeSizeAttribute(this)">
                        <label for="numLikes">number of likes</label>
                    </div>
                    <div class="singleOption">
                        <input type="radio" id="numComments" name="nodeSizeAttribute" value="numComments" onclick="updateNodeSizeAttribute(this)">
                        <label for="numComments">number of comments</label>
                    </div>
                    <div class="singleOption">
                        <input type="radio" id="likesCommentsRatio" name="nodeSizeAttribute" value="numComments/numLikes" onclick="updateNodeSizeAttribute(this)">
                        <label for="likesCommentsRatio">comments / likes</label>
                    </div>
                    <div class="singleOption">
                        <input type="radio" id="uniformNodeSize" name="nodeSizeAttribute" value="" onclick="updateNodeSizeAttribute(this)" checked>
                        <label for="uniformNodeSize">use uniform size</label>
                    </div>
                </div>
            </div>
            <div class="vizOptionsContainer">
                <p>Nodes with no edges going into or out of them are not shown by default.</p>
                <div class="networkVizOptions">
                    <div class="singleOption">
                        <input type="checkbox" name="showLoneNodes" onclick="updateTree()">
                        <label for="showLoneNodes">Show lone nodes</label>
                    </div>
                </div>
            </div>
            <div class="vizOptionsContainer">
                <p>Click on a non-leaf node to select it, and then click the button below to collapse or expand the node</p>
                <button id="collapseExpandButton" onclick="collapseOrExpandSelectedNode()" disabled>Select a node to collapse</button>
                <button id="deselectNodesButton" onclick="attemptDeselectNodes()">Deselecte current node(s)</button>
            </div>
            <div class="vizOptionsContainer">
                <p>The selected node's information is displayed below</p>
                <div id="tooltip">
                    <div class="attributeContainer">
                        <div class="attributeLabel">Node ID:</div>
                        <div class="attributeValue" id="idField">###</div>
                    </div>
                    <div class="attributeContainer">
                        <div class="attributeLabel">Timestamp:</div>
                        <div class="attributeValue" id="timestampField">###</div>
                    </div>
                    <div class="attributeContainer">
                        <div class="attributeLabel">Number of Likes:</div>
                        <div class="attributeValue" id="numLikesField">###</div>
                    </div>
                    <div class="attributeContainer">
                        <div class="attributeLabel">Number of Comments:</div>
                        <div class="attributeValue" id="numCommentsField">###</div>
                    </div>
                    <div class="attributeContainer">
                        <div class="attributeLabel">Degree of Contribution:</div>
                        <div class="attributeValue" id="degContributionField">###</div>
                    </div>
                </div>
            </div>  
        </div>
        <div id='bar_chart_div'>
            <div id="bar_chart_viz"></div>
            <div id="bar_chart_controls">
                <button onClick="goBack(this)" id="goBackButton" disabled>Go Back</button>
            </div>
        </div>
    </div>
    <div id="complete_viz">
    <!-- Create a div where the graph will take place -->
        <div id="viz">
            <svg id="network">
                <defs>
                    <linearGradient id="verticalGradFollowedUp" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:rgb(255,0,0);stop-opacity:1" />
                        <stop offset="100%" style="stop-color:rgb(0,0,255);stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="verticalGradFollowerUp" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:rgb(0,0,255);stop-opacity:1" />
                        <stop offset="100%" style="stop-color:rgb(255,0,0);stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="horizontalGradFollowedLeft" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:rgb(255,0,0);stop-opacity:1" />
                        <stop offset="100%" style="stop-color:rgb(0,0,255);stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="horizontalGradFollowerLeft" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:rgb(0,0,255);stop-opacity:1" />
                        <stop offset="100%" style="stop-color:rgb(255,0,0);stop-opacity:1" />
                    </linearGradient>
                    <pattern id="patternCheckers" x="0" y="0" width="4" height="4" patternUnits="userSpaceOnUse" >
                        <rect class="checker" x="0" width="2" height="2" y="0"/>
                        <rect class="checker" x="2" width="2" height="2" y="2"/>
                    </pattern>
                </defs>
            </svg>
            <div id="levelBarContainer">
                <svg id="levelBar">
                </svg>
            </div>
            <div id="legend">
                <div style="text-align: center;">Legend</div>
                <div class="legendItem">
                    <div class="graphicWrapper">
                        <div class="legendGraphic" id="nodeLegend"></div>
                    </div>
                    <div class="legendText">A user who has posted the viral hashtag</div>
                </div>
                <div class="legendItem">
                    <div class="graphicWrapper">
                        <div class="legendGraphic" id="followerLegend"></div>
                    </div>
                    <div class="legendText">End of edge connected to the user following another user</div>
                </div>
                <div class="legendItem">
                    <div class="graphicWrapper">
                        <div class="legendGraphic" id="followedLegend"></div>
                    </div>
                    <div class="legendText">End of edge connected to the user being followed</div>
                </div>
                <div class="legendItem">
                    <div id="levelBarIndicatorText">Bottom level bar</div>
                    <div id="levelLegend">
                        <div class="legendText">Highest ranked by number of nodes</div>
                        <div class="graphicWrapper">
                            <div class="legendGraphic" id="levelBarColors"></div>
                        </div>
                        <div class="legendText">Lowest ranked by number of nodes</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* UI variables */
    var sidebarWidth = document.getElementById('sidebarTool').clientWidth;
    var windowWidth = window.innerWidth;
    var networkGraphWidth = document.getElementById('complete_viz').clientWidth////windowWidth - d3.select("#complete_tool").node().getBoundingClientRect().width - 15;
    var nodeWidth;  // this will be set in the tree drawing function
    var windowHeight = window.innerHeight;
    var levelGraphHeight = 30;
    var networkGraphHeight = document.getElementById('complete_viz').clientHeight - 20 - levelGraphHeight;//windowHeight * 0.95;
    var levelGraphYPos;  // this will be set in the tree drawing function
    var barGraphHeight = document.getElementById('bar_chart_div').clientHeight//windowHeight * 0.3;
    var useGradientOnTreeEdges = true;
    var useGradientOnExtraEdgesWithin = true;
    var useGradientOnExtraEdgesAcross = true;
    var selectedNodeId = null;
    var attributeForNodeSize = null;

    let selectedNodesIds = []

    /*Bar chart variables*/
    let bar_svg = null
    let timestamps = []
    let updatableData = []
    let curr_time_measures = {}
    let xAxisLabel = ""

    /*level bar variables*/
    let nodesPerLevel = []

    /* svg variables */
    var svg = d3.select("#network");
    var solidEdgeColor = "#555";
    var minRadius = 1;
    var maxRadius = 2;
    var midRadius = (minRadius + maxRadius) / 2
    var nodeSizeScale;
    var arcHeightScale;
    var hiddenNodeSet = new Set();
    var collapsedNodeSet = new Set();

    /* data loading and preprocessing */
    var nodeData;   // list of nodes
    var nonLoneNodes;
    var showLoneNodes = false;
    var loneNodes;
    // TODO: delete var linkData;   // list of links
    var nodeLookup = {};    // maps node id to node object for easy lookup
    var fakeRoot;   // used to store all level 0 nodes as children for easier drawing
    var tree;   // used to store all level 0 nodes as children for easier drawing
    
    d3.json("data/urban_dictionary_tweets_and_followers.json").then(function(data) {
        // TODO: delete nodeData = data.nodes;
        // TODO: delete linkData = data.links;
        console.log(data);
        nodeData = data;
        loneNodes = preprocessData(nodeData, nodeLookup);   // transform data into the format we want
        //nodeData.forEach(item => item.timestamp = item.timestamp*1000) //get rid of this line later, we expect the timestamp to be in millis by default
        fakeRoot = transformToNested(nodeData);
        console.log(nodeData);
        computeDegreeOfContributionForAllNodes(nodeData, nodeLookup);
        tree = Tree(fakeRoot, {
            /*label: d => d.id,*/
            sort: (a, b) => a.timestamp - b.timestamp,
            width: networkGraphWidth,
            height: networkGraphHeight,
            r: maxRadius
        });
        drawTimestampBarChart(nodeData);
        //drawLevelBars(tree)   /* this is now drawn in the tree function */
        console.log(fakeRoot);
    });
</script>
</body>
</html>
